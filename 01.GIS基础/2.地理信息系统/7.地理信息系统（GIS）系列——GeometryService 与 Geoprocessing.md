- [地理信息系统（GIS）系列——GeometryService 与 Geoprocessing](https://yanyan.blog.csdn.net/article/details/113098818)

# 1、空间分析

空间分析是基于地理对象的位置和形态的空间数据的分析技术，其目的在于提取和传输空间信息。空间分析是地理信息系统的主要特征。空间分析能力（特别是对空间隐含信息的提取和传输能力）是地理信息系统区别与一般信息系统的主要方面，也是评价一个地理信息系统成功与否的一个主要指标。

## 空间分析种类

- 缓冲区分析
- 叠加分析
- 网络分析
- 统计分析
- 地理处理分析
- 地理编码分析
- 数字高程模型分析
- 影像分析

## 空间分析特性

### 空间查询

空间分析是GIS的核心和灵魂，是GIS区别于一般的信息系统、CAD或者电子地图系统的主要标志之一。 空间分析，配合空间数据的属性信息，能提供强大、丰富的空间数据查询功能。 因此，空间分析在GIS中的地位不言而喻。

### 数据挖掘

空间分析是为了解决地理空间问题而进行的数据分析与数据挖掘，是从GIS目标之间的空间关系中获取派生的信息和新的知识，是从一个或多个空间数据图层中获取信息的过程。空间分析通过地理计算和空间表达挖掘潜在的空间信息，其本质包括探测空间数据中的模式；研究数据间的关系并建立空间数据模型；使得空间数据更为直观表达出其潜在含义；改进地理空间事件的预测和控制能力。

### 空间分析

空间分析主要通过空间数据和空间模型的联合分析来挖掘空间目标的潜在信息，而这些空间目标的基本信息，无非是其空间位置、分布、形态、距离、方位、拓扑关系等，其中距离、方位、拓扑关系组成了空间目标的空间关系，它是地理实体之间的空间特性，可以作为数据组织、查询、分析和推理的基础。通过将地理空间目标划分为点、线、面不同的类型，可以获得这些不同类型目标的形态结构。将空间目标的空间数据和属性数据结合起来，可以进行许多特定任务的空间计算与分析。

## 空间服务技术：

### GeometryService

用于处理几何对象的空间服务，如：投影转换、简化对象、缓冲区、测量、判断空间关系、计算标注点等功能。通俗点讲，就是基于几何空间服务的一组功能接口，一组web服务。

### Geoprocessing

GP服务是Geoprocessing服务的简称，Geoprocessing包含了一系列地理数据处理的功能，像做缓冲区分析、叠加分析、以及对栅格数据制作阴影图等等。在桌面软件中可以通过ArcToolbox中的工具直接调用Geoprocessing的功能，而如果期望通过web来调用GP的功能，就必须借助于GP服务了。通俗点讲，就是为webgis实现复杂空间服务，提供的桌面ArcToolbox中的工具的一种web服务。

## SOE

SOE是为WebGIS提供空间服务的，基于AO技术实现COM组件式的web服务。

## 其他空间服务技术

- 地理处理服务
- 地理编码
- 网络分析服务（路径分析）
- 服务器渲染服务

# 2、GeometryService

## GeometryService 服务

- 通过 ArcGIS Server 管理后台启动 GeometryService 服务
- 优点：速度快，轻量级
- 缺点：无法扩展，方法写死

## GeometryService 类

    用于几何空间服务的类，提供一些空间分析的方法，如：缓冲区、加密、计算面积和周长等等

## GeometryService 构造函数

```js
new GeometryService(url)
```

- url：几何服务路径

## GeometryService 方法

### areasAndLengths：计算面积和长度

```js
areasAndLengths(areasAndLengthsParameters, callback?, errback?)
```

- 计算指定输入的每个多边形面积和周长
- 返回：Deferred 延期类
- 参数1：areasAndLengthsParameters
- 参数2：回调函数
- 参数3：返回错误函数

### areasAndLengthsParameters：面积和长度参数类

- 属性：
- areaUnit：面积单位
- calculationType：定义了几何计算的类型
- lengthUnit：长度单位
- polygons：多边形计算面积和长度

### calculationType：几何计算的类型

- planar：使用二维笛卡尔平面测量长度
- geodesic：仅使用多边形的顶点连接线段测量长度和面积
- preserveShape：计算几何图形的面积或长度在投影或地理坐标系统的地球椭球体表面的长度和面积

### autoComplete：自动合闭

```js
autoComplete(polygons, polylines, callback?, errback?)
```

- 创建填充一个多边形对象与一组线对象之间间隙的一个多边形对象
- 返回：Deferred 延期类
- 参数1：多边形
- 参数2：折线
- 参数3：回调函数
- 参数4：返回错误函数

### buffer：缓冲区

```js
buffer(bufferParameters, callback?, errback?)
```

- 返回对输入几何对象指定距离的一系列对象
- 返回：Deferred 延期类
- 参数1：bufferParameters 缓冲区参数
- 参数2：回调函数
- 参数3：返回错误函数

### bufferParameters：缓冲区分析参数类

- bufferSpatialReference：缓冲分析空间参考
- distances：距离
- geodesic：输入几何图形缓冲区
- outSpatialReference：输出空间参考
- unionResults：联合结构
- unit：单位

### convexHull：计算凸多边形

```js
convexHull(geometries, callback?, errback?)
```

- 参数1：geometries 几何图形
- 参数2：回调函数
- 参数3：返回错误函数

### cut：裁剪

```js
cut(geometries, cutterGeometry, callback?, errback?)
```

- 使用拆分线将输入的线或多边形拆分成两部分
- 返回：Deferred延期类
- 参数1：几何图形集合
- 参数2：切割几何图形
- 参数3：回调函数
- 参数4：返回错误函数

### densify：加密

```js
densify(densifyParameters, callback?, errback?)
```

- 通过在现有节点间增加新的节点来增加几何对象节点的密度
- 返回：Deferred延期类
- 参数1：densifyParameters，加密参数
- 参数2：回调函数
- 参数3：返回错误函数

### densifyParameters：加密参数

- 输入参数为致密方法，包含几何图形，maxSegmentLength 和可选 lengthUnit
- geodesic：几何图形
- lengthUnit：长度单位
- maxSegmentLength：最大段长度

### Difference：求差

```js
difference(geometries, geometry, callback?, errback?)
```

- 计算一组几何对象与另外一个几何对象差异部分，即不相交部分
- 返回：Deferred 延期类
- 参数1：几何图形集合
- 参数2：几何图形
- 参数3：回调函数
- 参数4：返回错误函数

### distance：计算距离

```js
distance(params, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：参数 DistanceParameters 类
- 参数2：回调函数
- 参数3：返回错误函数

### DistanceParameters：距离参数类

- distanceUnit：距离单位
- geodesic
- geometry1：图形1
- geometry2：图形2

### fromGeoCoordinateString：地理坐标转换字符串

```js
fromGeoCoordinateString(params, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：转换参数
- 参数2：回调函数
- 参数3：返回错误函数

### generalize：泛化

```js
generalize(params, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：参数
- 参数2：回调函数
- 参数3：返回错误函数

### GeneralizeParameters

- deviationUnit：偏差单位
- geometries：几何对象集合
- maxDeviation：最大偏差

### intersect：求几何对象相交部分

```js
intersect(geometries, geometry, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：几何图形集合
- 参数2：几何图形
- 参数3：回调函数
- 参数4：返回错误函数

### labelPoints：计算标记点

```js
labelPoints(polygons, callback?, errback?)
```

- 计算多边形内部的用于标注多边形的点
- 返回：Deferred 延期类
- 参数1：多边形
- 参数2：回调函数
- 参数3：返回错误函数

### lengths：计算输入线的长度

```js
lengths(lengthsParameter, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：长度参数
- 参数2：回调函数
- 参数3：返回错误函数

### lengthsParameter：长度计算参数

- calculationType：计算类型
- geodesic：为 true 可以计算长度
- lengthUnit：长度单位
- polylines：计算的线

### offset：将输入的几何对象进行偏移

```js
offset(params, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：偏差参数
- 参数2：回调函数
- 参数3：返回错误函数

### OffsetParameters：计算偏移参数

- bevelRatio：角度
- geometries：几何对象
- offsetDistance：偏移距离
- offsetHow：偏移方式
- offsetUnit：偏移单位

### offsetHow：偏移方式

- esriGeometryOffsetBevelled：斜切
- esriGeometryOffsetMitered：斜接
- esriGeometryOffsetRounded：圆

### project：投影

```js
project(params, callback?, errback?)
```

- 返回几何对象投影的一个数组
- 返回：Deferred 延期类
- 参数1：投影参数
- 参数2：回调函数
- 参数3：返回错误函数

### projectParameters：投影参数

- geometries：几何对象
- outSR：空间参考
- transformForward：向前转换
- transformation：{ wkid:id} 或 { wkt:string }

### relation：计算空间关系

```js
relation(relationParameters, callback?, errback?)
```

- 判断两个几何对象是否属于某空间关系
- 返回：Deferred 延期类
- 参数1：关系参数
- 参数2：回调函数
- 参数3：返回错误函数

### relationParameters

- geometries1：几何对象1
- geometries2：几何对象2
- relation：要分析的空间关系
- relationParam

### reshape：重塑线或多边形等几何对象

```js
reshape(targetGeometry, reshaperGeometry, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：目标几何图形
- 参数2：重塑几何图形
- 参数3：回调函数
- 参数4：返回错误函数

### simplify：简化

```js
simplify(geometries, callback?, errback?)
```

- 返回了一系列的简化几何对象
- 返回：Deferred 延期类
- 参数1：几何图形集合
- 参数2：回调函数
- 参数3：返回错误函数

### toGeoCoordinateString：转换成地理坐标字符串

```js
toGeoCoordinateString(params, callback?, errback?)
```

- 返回：Deferred 延期类
- 参数1：参数
- 参数2：回调函数
- 参数3：返回错误函数

### trimExtend：截断/延伸

```js
trimExtend(params, callback?, errback?)
```

- 对输入的线执行截断或延伸操作
- 返回：Deferred 延期类
- 参数1：参数
- 参数2：回调函数
- 参数3：返回错误函数

### trimExtendParameters

- extendHow：延伸方式
- polylines：延伸线
- trimExtendTo：截断/延伸至

### extendHow：延伸方式

- DEFAULT_CURVE_EXTENSION
- RELOCATE_ENDS
- KEEP_END_ATTRIBUTES
- NO_END_ATTRIBUTES
- NO_EXTEND_AT_FROM
- NO_EXTEND_AT_TO

### union：合并

```js
union(geometries, callback?, errback?)
```

- 将一组对象合并
- 返回：Deferred 延期类
- 参数1：参数
- 参数2：回调函数
- 参数3：返回错误函数

### GeometryService：事件

- areas-and-lengths-complete：完成面积和长度计算事件
- auto-complete-complete：自动合闭完成后产生事件
- buffer-complete：缓冲区分析完成后，产生事件
- convex-hull-complete：凸多边形完成计算后产生事件
- cut-complete：裁剪完成产生的事件
- densify-complete：加密完成事件
- difference-complete：求差计算完成后产生的事件
- distance-complete：距离计算完成产生事件
- error：错误产生事件
- generalize-complete：执行完综合操作后产生的事件
- intersect-complete：两个几何对象相交后产生的事件
- label-points-complete：计算标注点后产生事件
- lengths-complete：长度计算完成后，产生事件
- offset-complete：偏移完成后，产生的事件
- relation-complete：计算空间关系后产生的事件
- reshape-complete：重塑线或几何对象后产生的事件
- simplify-complete：简化方法完成后产生的事件
- trim-extend-complete：截断/延伸后产生的事件
- union-complete：合并完成后产生的事件

## 计算面积和长度：

```js
<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Measure Polygon Area and Perimeter</title>
  
  <link rel="stylesheet" href="http://jsapi.thinkgis.cn/esri/css/esri.css">
  <style>
    html, body, #mapDiv {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100%;
    }
    #info {
      bottom: 20px;
      color: #444;
      height: auto;
      font-family: arial;
      left: 20px;
      margin: 5px;
      padding: 10px;
      position: absolute;
      text-align: left;
      width: 200px;
      z-index: 40;
    }
    .label {
      display: inline-block;
      width: 4em;
    }
  </style>

  <script src="http://jsapi.thinkgis.cn/init.js"></script>
  <script>
      require(["dojo/dom",
            "dojo/_base/lang",
            "dojo/json",
            "esri/config",
            "esri/map",
            "esri/graphic",
            "esri/geometry/Geometry",
            "esri/geometry/Extent",
            "esri/SpatialReference",
            "esri/tasks/GeometryService",
            "esri/tasks/AreasAndLengthsParameters",
            "esri/toolbars/draw",
            "esri/symbols/SimpleFillSymbol"],
      function (
      		dom, 
      		lang, 
      		json, 
      		esriConfig, 
      		Map, 
      		Graphic, 
      		Geometry, 
      		Extent, 
      		SpatialReference, 
      		GeometryService, 
      		AreasAndLengthsParameters, 
      		Draw, 
      		SimpleFillSymbol
      ) {

          // 如果几何服务传送大于2000个字节
          // 如果无法执行，分析将执行一个POST代理
          esriConfig.defaults.io.proxyUrl = "http://localhost:48429/DotNet/";//代理路径，下载离线部署文档https://github.com/ESRI/resource-proxy/releases
          // 是否总是使用REST端点代理进行通信，这里是否，也就是不总是使用，而是大于2000字节的时候，使用
          esriConfig.defaults.io.alwaysUseProxy = false;

          var map = new Map("mapDiv", {
              basemap: "topo",
              center: [-122.778, 45.483],
              zoom: 15
          });

          map.on("load", function () {
              var tb = new Draw(map);
              // lang.hitchb在MAP范围内执行getAreaAndLength方法
              tb.on("draw-end", lang.hitch(map, getAreaAndLength));
              // 画多边形
              tb.activate(Draw.FREEHAND_POLYGON);
          });
           // 创建几何服务
          var geometryService = new GeometryService("http://sampleserver6.arcgisonline.com/arcgis/rest/services/Utilities/Geometry/GeometryServer");
          // 计算完成时间绑定
          geometryService.on("areas-and-lengths-complete", outputAreaAndLength);

          function getAreaAndLength(evtObj) {
              var map = this,
                  geometry = evtObj.geometry;
              map.graphics.clear();
			  // 在地图上绘制图形
              var graphic = map.graphics.add(new Graphic(geometry, new SimpleFillSymbol()));

              // 创建计算参数
              var areasAndLengthParams = new AreasAndLengthsParameters();
              // 英尺
              areasAndLengthParams.lengthUnit = GeometryService.UNIT_FOOT;
              // 英亩
              areasAndLengthParams.areaUnit = GeometryService.UNIT_ACRES;
              // 定义了几何计算的类型,使用这种计算面积或长度仅使用多边形的顶点定义线连接的顶点作为测地线段独立的实际形状的多边形
              areasAndLengthParams.calculationType = "geodesic";
              // 返回了一系列的简化几何对象，确保拓扑关系正确
              geometryService.simplify([geometry], function (simplifiedGeometries) {
                  areasAndLengthParams.polygons = simplifiedGeometries;
                  geometryService.areasAndLengths(areasAndLengthParams);
              });
          }
          // 当我们计算完成后，返回数据
          function outputAreaAndLength(evtObj) {
              var result = evtObj.result;
              console.log(json.stringify(result));
              dom.byId("area").innerHTML = result.areas[0].toFixed(3) + " acres";
              dom.byId("length").innerHTML = result.lengths[0].toFixed(3) + " feet";
          }
      });
  </script>

  </head>
  <body>
    <div id="mapDiv"></div>
    <div id="info" class="esriSimpleSlider">
      Draw a polygon to be used as input to the geometryService's areasAndLengths() operation.
      <br><br>
      <span class="label">Area:</span> <span id="area"></span>
      <br>
      <span class="label">Length:</span> <span id="length"></span>
    </div>
  </body>
</html>
```

## 计算凸多边形：

```js
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Convex Hull</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
    <style>
      html, body { 
      	height: 100%; 
      	width: 100%; 
      	margin: 0; 
      	padding: 0; 
      }
      #mapu { 
      	padding:0; 
      }
      #titlePane {
        width:200px;
        height:300px;
      }
      .claro .dijitTitlePaneTitle {
        background: #A4BDA7;
        font-weight:600;
        color:#33292B;
      }
      .dijitButtonNode {
        background-color: #A4BDA7 !important;
        border: 1px solid #646750 !important;
        color:#33292B !important;
      }
    </style>

    <script>var dojoConfig = { parseOnLoad: true };</script>
    <script src="http://js.arcgis.com/3.14/"></script>
    <script>
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("dijit.TitlePane");
        dojo.require("esri.map");
        dojo.require("esri.layers.FeatureLayer");
        dojo.require("esri.toolbars.draw");
        dojo.require("esri.tasks.geometry");

        var map;
        var toolbar;
        var geometryService;
        var featureLayer;

        function init() {
            // 如果几何服务传送大于2000个字节
            // 如果无法执行，分析将执行一个POST代理
            esri.config.defaults.io.proxyUrl = "/proxy/";
            esri.config.defaults.io.alwaysUseProxy = false;
            // 创建几何服务
            geometryService = new esri.tasks.GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

            map = new esri.Map("map", {
                basemap: "topo",
                center: [-72.517, 42.372],
                zoom: 16
            });

            // 图层要素服务
            featureLayer = new esri.layers.FeatureLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/0", {
                mode: esri.layers.FeatureLayer.MODE_ONDEMAND,
                outFields: ["POP2000", "BLOCK"]
            });

            // 符号
            var symbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE, 12, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([247, 0, 171, 0.9]), 2), new dojo.Color([247, 0, 171, 0.5]));
            featureLayer.setSelectionSymbol(symbol);

            map.infoWindow.resize(175, 100);
            map.addLayer(featureLayer);

            dojo.connect(map, 'onLoad', function (theMap) {
                // 创建绘图 
                toolbar = new esri.toolbars.Draw(map);
                dojo.connect(toolbar, "onDrawEnd", drawEndHandler);
            });
        }
        function activateToolbar() {
            toolbar.activate(esri.toolbars.Draw.EXTENT);
        }
        function drawEndHandler(geometry) {
            // 绘图工具无效
            toolbar.deactivate();
            // 清除绘图层
            map.graphics.clear();
            // 创建查询对象
            var query = new esri.tasks.Query();
            // 获取查询图像
            query.geometry = geometry;
            // 执行查询
            featureLayer.selectFeatures(query, esri.layers.FeatureLayer.SELECTION_NEW, function (features) {
                // 将图像地图化
                var points = dojo.map(features, function (feature) {
                    return feature.geometry;
                });
                // 分析凸边形
                geometryService.convexHull(points, function (result) {
                    var symbol;
                    switch (result.type) {
                        case "point":
                            symbol = new esri.symbol.SimpleMarkerSymbol();
                            alert("点");
                            break;
                        case "polyline":
                            symbol = new esri.symbol.SimpleLineSymbol();                          
                           alert("线");
                            break;
                        case "polygon":
                            symbol = new esri.symbol.SimpleFillSymbol();
                            alert("面");
                            break;
                    }
                    map.graphics.add(new esri.Graphic(result, symbol));
                }, function (error) {
                    console.log("An error occured during convex hull calculation");
                });
            });
        }
        dojo.ready(init);
    </script>
  </head>
  
  <body class="claro">
    <div data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="gutters:'false',design:'headline'" style="width: 100%; height: 100%;">
      <div id="map" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'"  style="overflow:hidden;">
      <div style="position:absolute; right:20px; top:10px; z-Index:999;">
        <div id="titlePane" data-dojo-type="dijit.TitlePane" data-dojo-props="title:'Convex Hull', closable:'false', open:'true'">
            <p style="padding:5px 2px;color:#33292B;">Draw a rectangle around a group of block points to calculate the 
              minimum bounding polygon ("convex hull") of the selected points.</p>
            <button data-dojo-type="dijit.form.Button" data-dojo-props="onClick:activateToolbar">Draw</button>
        </div>
      </div>
      </div>
    </div>
  </body>
</html>
```

## 缓冲区分析

```js
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
	<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
	<title>Buffer</title>

	<link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/claro/claro.css">
	<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
	<style>
	   html, body {
	    height: 100%;
	    width: 100%;
	    margin: 0; 
	    padding: 0;
	    overflow:hidden;
	  }
	  #leftPane{
	    color:#000;
	    width:250px;
	    padding-bottom:15px;
	  }
	  #map{
	    padding:0;
	  }
	  .details{
	    font-size:14px;
	    font-weight:600;
	    padding-bottom:20px;
	  }	
	  button{
	    margin:2px;
	    cursor:pointer;
	  }
	</style>

	<script src="http://js.arcgis.com/3.14/"></script>
	<script>
	    var map, tb;
	
	    require([
	    	"dojo/dom",
            "dojo/_base/array",
            "dojo/parser",
            "dojo/query",
            "dojo/on",
            "esri/Color",
            "esri/config",
            "esri/map",
            "esri/graphic",
            "esri/geometry/normalizeUtils",
            "esri/tasks/GeometryService",
            "esri/tasks/BufferParameters",
            "esri/toolbars/draw",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane",
            "dijit/form/Button", "dojo/domReady!"
    	], function (
    		dom, 
    		array, 
    		parser, 
    		query, 
    		on, 
    		Color, 
    		esriConfig, 
    		Map, 
    		Graphic, 
    		normalizeUtils, 
    		GeometryService, 
    		BufferParameters, 
    		Draw, 
    		SimpleMarkerSymbol, 
    		SimpleLineSymbol, 
    		SimpleFillSymbol
    	) {

              parser.parse();

              esriConfig.defaults.geometryService = new GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

              esriConfig.defaults.io.proxyUrl = "/proxy/";
              esriConfig.defaults.io.alwaysUseProxy = false;

              // 绑定清除图层单击事件
              on(dom.byId("clearGraphics"), "click", function () {
                  if (map) {
                      map.graphics.clear();
                  }
              });
              // 绑定工具单击事件
              query(".tool").on("click", function (evt) {
                  if (tb) {
                      tb.activate(evt.target.id);
                  }
              });

              map = new Map("map", {
                  basemap: "streets",
                  center: [-111.5, 39.541],
                  zoom: 7
              });
              map.on("load", initToolbar);

              function initToolbar(evtObj) {
                  tb = new Draw(evtObj.map);
                  tb.on("draw-end", doBuffer);
              }

              function doBuffer(evtObj) {
                  tb.deactivate();
                  var geometry = evtObj.geometry, symbol;
                  switch (geometry.type) {
                      case "point":
                          symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 10, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 0, 0]), 1), new Color([0, 255, 0, 0.25]));
                          break;
                      case "polyline":
                          symbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASH, new Color([255, 0, 0]), 1);
                          break;
                      case "polygon":
                          symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NONE, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]));
                          break;
                  }

                  var graphic = new Graphic(geometry, symbol);
                  map.graphics.add(graphic);

                  // 创建缓冲区参数
                  var params = new BufferParameters();
                  params.distances = [dom.byId("distance").value];
                  params.outSpatialReference = map.spatialReference;
                  params.unit = GeometryService[dom.byId("unit").value];
                  // normalize the geometry 
                  // 标准化几何对象
                  // 规范化的几何图形中央子午线相交或超出世界范围的图像，让他们保持在当前的坐标系统。
                  normalizeUtils.normalizeCentralMeridian([geometry]).then(function (normalizedGeometries) {
                      var normalizedGeometry = normalizedGeometries[0];
                      if (normalizedGeometry.type === "polygon") {
                          // 如果一个多边形几何简化多边形。这将使用户绘制多边形拓扑正确的。
                          esriConfig.defaults.geometryService.simplify([normalizedGeometry], function (geometries) {
                              params.geometries = geometries;
                              esriConfig.defaults.geometryService.buffer(params, showBuffer);
                          });
                      } else {
                          params.geometries = [normalizedGeometry];
                          esriConfig.defaults.geometryService.buffer(params, showBuffer);
                      }

                  });
              }

              function showBuffer(bufferedGeometries) {
                  var symbol = new SimpleFillSymbol(
                    SimpleFillSymbol.STYLE_SOLID,
                    new SimpleLineSymbol(
                      SimpleLineSymbol.STYLE_SOLID,
                      new Color([255, 0, 0, 0.65]), 2
                    ),
                    new Color([255, 0, 0, 0.35])
                  );

                  array.forEach(bufferedGeometries, function (geometry) {
                      var graphic = new Graphic(geometry, symbol);
                      map.graphics.add(graphic);
                  });

              }
          });
</script>

</head>

<body class="claro">
<div data-dojo-type="dijit/layout/BorderContainer" 
     data-dojo-props="gutters:'true', design:'sidebar'" 
     style="width:100%;height:100%;">

  <div id="map" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'center'">
  </div>

  <div id="leftPane" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'left'">
    <div class="details">Pick a tool and draw on the map. The drawn graphic will be buffered based on the specified parameters.</div>
    <button type="button" class="tool" id="line">Line</button>
    <button type="button" class="tool" id="polyline">Polyline</button>
    <button type="button" class="tool" id="freehandpolyline">Freehand Polyline</button>
    <br/>
    <button type="button" class="tool" id="polygon">Polygon</button>
    <button type="button" class="tool" id="freehandpolygon">Freehand Polygon</button>
    <br/><hr />
    <div><b>Buffer Parameters</b></div>
    Distance: <input type="text" id="distance" size="5" value="25" />
    <select id="unit" style="width:100px;">
      <option value="UNIT_STATUTE_MILE">Miles</option>
      <option value="UNIT_FOOT">Feet</option>
      <option value="UNIT_KILOMETER">Kilometers</option>
      <option value="UNIT_METER">Meters</option>
      <option value="UNIT_NAUTICAL_MILE">Nautical Miles</option>
      <option value="UNIT_US_NAUTICAL_MILE">US Nautical Miles</option>
      <option value="UNIT_DEGREE">Degrees</option>
    </select><br />
    <button type="button" id="clearGraphics"  type="button">Clear Graphics</button>
  </div>
</div>
</body>
</html>
```

## 空间关系分析

```js
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
	<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
	<title>Buffer</title>
	
	<link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/claro/claro.css">
	<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
	<style>
	   html, body {
	    height: 100%;
	    width: 100%;
	    margin: 0; 
	    padding: 0;
	    overflow:hidden;
	  }
	  #leftPane {
	    color:#000;
	    width:250px;
	    padding-bottom:15px;
	  }
	  #map {
	    padding:0;
	  }
	  .details {
	    font-size:14px;
	    font-weight:600;
	    padding-bottom:20px;
	  }	
	  button {
	    margin:2px;
	    cursor:pointer;
	  }
	</style>
	<script src="http://js.arcgis.com/3.14/"></script>
	<script src="js0906.js"></script>
</head>

<body class="claro">
<div data-dojo-type="dijit/layout/BorderContainer" 
     data-dojo-props="gutters:'true', design:'sidebar'" 
     style="width:100%;height:100%;">

  <div id="map" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'center'">
  </div>

  <div id="leftPane" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'left'">
      <div>
        <button id="polygonBtn" type="button">多边形</button>
        <button id="removeBtn" type="button">删除多边形</button>
        选择空间关系：
        <select id="relation">
            <option value="SPATIAL_REL_WITHIN">包含</option>
            <option value="SPATIAL_REL_INTERSECTION">相交</option>
            <option value="SPATIAL_REL_DISJOINT">分离</option>
        </select>
    </div>    
  </div>
</div>
</body>
</html>
```

```js
## js0906.js

require([
	"dojo/parser", 
	"dojo/dom", 
	"dojo/on", 
	"esri/map", 
	"esri/layers/ArcGISTiledMapServiceLayer", 
	"esri/layers/GraphicsLayer", 
	"esri/graphic", 
	"esri/toolbars/draw",
    "esri/symbols/SimpleLineSymbol", 
    "esri/symbols/SimpleFillSymbol", 
    "esri/Color", 
    "esri/tasks/GeometryService", 
    "esri/tasks/RelationParameters", 
    "dojo/domReady!"
], function (
	parser,
	dom, 
	on, 
	Map, 
	ArcGISTiledMapServiceLayer, 
	GraphicsLayer, 
	Graphic, 
	Draw, 
	SimpleLineSymbol, 
	SimpleFillSymbol, 
	Color, 
	GeometryService, 
	RelationParameters
) {

        parser.parse();
        // 定义地图对象
        var map = new esri.Map("map");
        // 定义绘图工具对象
        var td;
        var myTiledMapServiceLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineCommunity/MapServer");
        // 添加静态图层
        map.addLayer(myTiledMapServiceLayer);
        map.setZoom(4);
		// 创建绘图图层
        var graphicLayer = new GraphicsLayer();
        // 添加到地图中
        map.addLayer(graphicLayer);
        map.on("load", initToolbar);

        function initToolbar(evtObj) {
            tb = new Draw(map);
            tb.on("draw-end", addGraphic);
        }    

        var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));
        var resultSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 0, 0]), 2), new dojo.Color([0, 255, 0, 0.5]));

        // 实例化几何服务
        var gsvc = new GeometryService("http://sampleserver1.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer");
        var relationParams = new RelationParameters();
        // 绑定绘图按钮
        on(dom.byId("polygonBtn"), "click", function () {
          	// alert("fdfd");
            tb.activate(Draw.POLYGON);
        });
       	// 绑定清除图层单击事件
        on(dom.byId("removeBtn"), "click", function () {
            graphicLayer.clear();
        });
        function addGraphic(evt) {
            if (graphicLayer.graphics.length >= 2) {
                alert("请先使用删除多边形按钮删除原来的多边形，才能继续！");
                return;
            }

            var handgraphic = new Graphic(evt.geometry, symbol);
            graphicLayer.add(handgraphic);

            if (graphicLayer.graphics.length === 2) {
                // 获取下拉框的值
                var relationship = document.getElementById("relation").value;
                // 包含
                if (relationship === "SPATIAL_REL_WITHIN") {
                    relationParams.relation = RelationParameters.SPATIAL_REL_WITHIN;
                // 相交
                } else if (relationship === "SPATIAL_REL_INTERSECTION") {
                    relationParams.relation = RelationParameters.SPATIAL_REL_INTERSECTION;
                } else {
                	// 分离
                    relationParams.relation = RelationParameters.SPATIAL_REL_DISJOINT;
                }
                relationParams.geometries1 = [graphicLayer.graphics[0].geometry];
                relationParams.geometries2 = [graphicLayer.graphics[1].geometry];
                gsvc.relation(relationParams, addRelateResultsToMap);
            }
        }

        function addRelateResultsToMap(relations) {
            for (var i = 0; i < relations.length; i++) {
                graphicLayer.graphics[relations[i].geometry1Index].setSymbol(resultSymbol);
                alert("返回结果");
            }
        }
 });
```

## 计算标记点

```js
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Geometry Service: Label Points</title>
    
    <link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/nihilo/nihilo.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
    <style>
      html, body, #mapDiv {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 100%;
      }
      #info {
        bottom: 20px;
        color: #444;
        height: auto;
        font-family: arial;
        left: 20px;
        margin: 5px;
        padding: 10px;
        position: absolute;
        width: 200px;
        z-index: 40;
      }
    </style>

    <script src="http://js.arcgis.com/3.14/"></script>
    <script>
        require([
	        "dojo/dom",
	        "dojo/dom-attr",
	        "dojo/_base/array",
	        "esri/Color",
	        "dojo/number",
	        "dojo/parser",
	        "dijit/registry",
	        "esri/config",
	        "esri/map",
	        "esri/graphic",
	        "esri/tasks/GeometryService",
	        "esri/tasks/BufferParameters",
	        "esri/toolbars/draw",
	        "esri/symbols/SimpleMarkerSymbol",
	        "esri/symbols/SimpleLineSymbol",
	        "esri/symbols/SimpleFillSymbol",
	        "esri/symbols/Font",
	        "esri/symbols/TextSymbol",
	        "dijit/layout/BorderContainer",
	        "dijit/layout/ContentPane"
        ], function (
        	dom, 
        	domAttr, 
        	array, 
        	Color, 
        	number, 
        	parser, 
        	registry, 
        	esriConfig, 
        	Map, 
        	Graphic, 
        	GeometryService, 
        	BufferParameters, 
        	Draw,
            SimpleMarkerSymbol, 
            SimpleLineSymbol, 
            SimpleFillSymbol, 
            Font, 
            TextSymbol
        ) {

            var map, toolbar, geometryService;

            parser.parse();
            // 定义地图对象
            map = new esri.Map("map");
            var myTiledMapServiceLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineCommunity/MapServer");
            // 添加静态图层
            map.addLayer(myTiledMapServiceLayer);
            map.setZoom(4);

            // configure the proxy url for the application
          	esriConfig.defaults.io.proxyUrl = "/proxy/";
            esriConfig.defaults.io.alwaysUseProxy = false;

            // 绘图工具
            toolbar = new Draw(map);
            toolbar.on("draw-end", addToMap);

            // 画多边行
            registry.byId("polygon").on("click", function () {
                toolbar.activate(Draw.POLYGON);
                map.hideZoomSlider();
            });
            // 任意画图形
            registry.byId("freehand").on("click", function () {
                toolbar.activate(Draw.FREEHAND_POLYGON);
                map.hideZoomSlider();
            });
            // 清除图层
            registry.byId("clear").on("click", function () {
                map.graphics.clear();
            });

            geometryService = new GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

            function addToMap(evtObj) {
                map.graphics.clear();
                // 获取几何对象
                var geometry = evtObj.geometry;
                // add the drawn graphic to the map
                var symbol = new SimpleFillSymbol(
                  SimpleFillSymbol.STYLE_SOLID,
                  new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0, 0, 0]), 2),
                  new Color([0, 0, 255, 0.5]));
                // 创建绘制对象
                var graphic = new Graphic(geometry, symbol);
                // 在地图中绘制地图
                map.graphics.add(graphic);

                // simplify polygon so it can be used in the get label points request
                // 简化几何对象
                geometryService.simplify([geometry], getLabelPoints);
            }

            function getLabelPoints(geometries) {
                if (geometries[0].rings.length > 0) {
                	// 计算标注多边形点
                    geometryService.labelPoints(geometries, function (labelPoints) { 
                        toolbar.deactivate();
                        map.showZoomSlider();
						// 字体
                        var font = new Font("20px", Font.STYLE_NORMAL, Font.VARIANT_NORMAL, Font.WEIGHT_BOLDER);
       					// 循环
                        array.forEach(labelPoints, function (labelPoint) {
                            // create a text symbol
                            var textSymbol = new TextSymbol(
                              "X: " + number.format(labelPoint.x) + ", Y: " + number.format(labelPoint.y),
                              font, new Color([0, 0, 0]));

                            var labelPointGraphic = new Graphic(labelPoint, textSymbol);

                            // add the label point graphic to the map
                            // 添加到图层中
                            map.graphics.add(labelPointGraphic);
                        });
                    });
                } else {
                    alert("Invalid Polygon - must have at least 3 points");
                }
            }
        });
  </script>

  </head>

  <body class="nihilo">
    <div id="map"></div>
    <div id="info" class="esriSimpleSlider">
      <button id="polygon" data-dojo-type="dijit.form.Button">Polygon</button>
      <button id="freehand" data-dojo-type="dijit.form.Button">Freehand Polygon</button>
      <button id="clear" data-dojo-type="dijit.form.Button">Clear Graphics</button>
    </div>
  </body>

</html>
```

# 3、Geoprocessing

## API 开发 GP 服务步骤

- 创建 GP 服务模型
- 测试 GP 服务模型
- 发布 GP 服务
- ArcGIS JavaScript 调用

## Model Builder

模型构建器是一个用来创建、编辑和管理模型的应用程序。模型是将一系列地理处理工具串联在一起的工作流，它将其中一个工具的输出作为另一个工具的输入。也可以将模型构建器看成是用于构建工作流的可视化编程语言。

## Model Builder 界面介绍

![image-20210818143954991](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210818143954991.png)

## 模型元素

模型元素主要有三种类型：工具、变量和连接符。

### 模型元素——工具

地理处理工具是模型中工作流的基本组成部分。工具用于对地理数据或表格数据执行多种操作。工具被添加到模型中后，即成为模型元素。

### 模型元素——变量

变量是模型中用于保存值或对磁盘数据的引用的元素。有以下两种类型的变量：

- 数据： 数据变量是包含磁盘数据的描述性信息的模型元素。数据变量中所描述的数据属性包括字段信息、空间参考和路径。
- 值： 值变量是诸如字符串、数值、布尔（真/假值）、空间参考、线性单位或范围等的值。值变量包含除对磁盘数据的引用之外的所有信息。

### 模型元素——连接符

连接符用于将数据和值连接到工具。连接符箭头显示执行处理的方向。有以下四种类型的连接符：

- 数据： 数据连接符用于将数据变量和值变量连接到工具。
- 环境： 环境连接符用于将包含环境设置的变量（数据或值）连接到工具。工具在执行时将使用该环境设置。
- 前提条件： 前提条件连接符用于将变量连接到工具。只有在创建了前提条件变量的内容之后，工具才会执行。
- 反馈： 反馈连接符用于将某工具的输出返回给同一工具作为输入。

### 模型流程

![image-20210818144025055](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210818144025055.png)

```js
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title></title>
	<link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/nihilo/nihilo.css"/>
	<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css"/>
	<style>
		html, body, #mapDiv {
			height: 100%;
			margin: 0;
			padding: 0;
			width: 100%;
		}
		#info {
			bottom: 20px;
			color: #444;
			height: auto;
			font-family: arial;
			left: 20px;
			margin: 5px;
			padding: 10px;
			position: absolute;
			width: 200px;
			z-index: 40;
		}
	</style>
	<script src="http://js.arcgis.com/3.14/"></script>
	<script>
		dojo.require("dijit.layout.BorderContainer");
		dojo.require("dijit.layout.ContentPane");
		dojo.require("esri.map");
		dojo.require("esri.toolbars.draw");
		dojo.require("esri.tasks.gp");
		var map, toolbar, gp;
		function init() {
			parser.parse();
			map = new esri.Map("map");
			var myTiledMapServiceLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineCommunity/MapServer");
			map.addLayer(myTiledMapServiceLayer);
			map.setZoom(4);
			dojo.connect(map, 'onLoad', function (theMap) {
			   dojo.connect(dijit.byId('map'), 'resize', map, map.resize);
			   // toolbar = new esri.toolbars.Draw(map);
			   dojo.connect(toolbar, 'onDrawEnd', drawEnd);
			});
			var button = dojo.byId("polygon");
			dojo.connect(button, 'onclick', drawPolygon);		
		}
		
		function drawPolygon() {
			toolbar.activate(esri.toolbars.Draw.POLYGON);		
		}
		
		function drawEnd(geometry) {
			toolbar.deactivate();
			var symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.25]));
			var graphic = new esri.Graphic(geometry, symbol);
			map.graphics.add(graphic);
			tojob(graphic);
		}
		
		function tojob(graphic) {
			// 第一步构造GP
			var gpUrl = 'http://localhost:6080/arcgis/rest/services/GP/ContaminatedAreas/GPServer/ContaminatedAreas';
			gp = new esri.tasks.Geoprocessor(gpUrl);
			// 第二步，构造参数
			// 我们通过上面，了解到GPFeatureRecordSetLayer对应FeatureSet
			var features = [];
			features.push(graphic);
			var featureset = new esri.tasks.FeatureSet();
			featureset.features = features;
			// 构造缓冲长度，这里的单位是可以更改的，我使用的是度，简单一些
			var Dis = new esri.tasks.LinearUnit();
			Dis.distance = 1;
			Dis.units = esri.Units.DECIMAL_DEGREES;
			// Distance__value_or_field_
			var parms = {
			   ContaminatedAreas: featureset,
			   Distance__value_or_field_: Dis
			};
			// 这里函数是异步的，使用函数是submitJob,同步的使用的是execute。
			// 成功之后，调用jobResult,建议看一下这个参数。
			gp.submitJob(parms, jobResult);
		}
		
		function jobResult(result) {
			var jobId = result.jobId;
			var status = result.jobStatus;
			if (status === esri.tasks.JobInfo.STATUS_SUCCEEDED) {
			   // 成功之后，将其中的结果取出来，当然这也是参数名字。
			   // 在模型中，想要取出中间结果，需要设置为模型参数
			   gp.getResultData(jobId, "polygon_Buffer", addResults);
			   gp.getResultData(jobId, "resultCity", addResults);
			}
		}
		// 将缓冲添加到地图上
		function addBufferResults(results) {
			console.log(results);
			var features = results.value.features;
			for (var i = 0, length = features.length; i != length; ++i) {
			   var feature = features[i];
			   var polySymbolRed = new esri.symbol.SimpleFillSymbol();
			   polySymbolRed.setOutline(new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 0, 0.5]), 1));
			   polySymbolRed.setColor(new dojo.Color([255, 0, 0, 0.5]));
			   feature.setSymbol(polySymbolRed);
			   map.graphics.add(feature);
			}
		}
		// 将受污染的城市，添加到地图上
		function addResults(results) {
			console.log(results);
			var features = results.value.features;
			for (var f = 0, fl = features.length; f < fl; f++) {
			   var feature = features[f];
			   var polySymbolRed = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE, 12, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([204, 102, 51]), 1), new dojo.Color([158, 184, 71, 1]));
			   feature.setSymbol(polySymbolRed);
			   map.graphics.add(feature);
			}
		}
		
		dojo.addOnLoad(init);
	</script>
</head>
<body class="nihilo">
	<div id="map"></div>
	<div id="info" class="esriSimpleSlider">
		<button id="polygon" data-dojo-type="dijit.form.Button">Polygon</button>
		<button id="freehand" data-dojo-type="dijit.form.Button">Freehand Polygon</button>
		<button id="clear" data-dojo-type="dijit.form.Button">Clear Graphics</button>
	</div>
</body>
</html>
```

## JavaScript 调用 GP 服务

```js
<!DOCTYPE html>
<html>
  <head>
     <meta charset="utf-8">
     <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
     <title></title>

     <link rel="stylesheet" href="https://js.arcgis.com/3.15/dijit/themes/tundra/tundra.css">
     <link rel="stylesheet" href="https://js.arcgis.com/3.15/esri/css/esri.css">
	 <style>
	   html, body {
	    height: 100%;
	    width: 100%;
	    margin: 0; 
	    padding: 0;
	    overflow:hidden;
	  }
	  #leftPane{
	    color:#000;
	    width:250px;
	    padding-bottom:15px;
	  }
	  #map{
	    padding:0;
	  }
	  .details{
	    font-size:14px;
	    font-weight:600;
	    padding-bottom:20px;
	  }	
	  button{
	    margin:2px;
	    cursor:pointer;
	  }
	</style>

    <script src="https://js.arcgis.com/3.15/"></script>
    <script>
        var app;

        require([
        	"dojo/dom",
            "dojo/_base/array",
            "dojo/date/locale",
            "dojo/parser",
            "dijit/registry",
            "esri/domUtils",
            "esri/map",
            "esri/graphic",
            "esri/layers/ArcGISDynamicMapServiceLayer",
            "esri/layers/FeatureLayer",
            "esri/tasks/Geoprocessor",
            "esri/dijit/Legend", 
            "esri/toolbars/draw", 
            "dojo/query",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/Color",
            "esri/graphic",
            "dijit/form/DateTextBox",
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane"
       ], function (
      		dom, 
      		array, 
      		locale, 
      		parser, 
      		registry,               
            domUtils, 
            Map, 
            Graphic, 
            ArcGISDynamicMapServiceLayer, 
            FeatureLayer, 
            Geoprocessor, 
            Legend, 
            Draw, 
            query, 
            SimpleMarkerSymbol, 
            SimpleLineSymbol, 
            SimpleFillSymbol, 
            Color, 
            graphic
      ) {
          var gpServiceUrl = "http://localhost:6080/arcgis/rest/services/gp/Model/GPServer/Model";
          parser.parse();

          var map = new Map("map", {
              basemap: "streets",
              center: [-122.81, 45.466],
              zoom: 13
          });

          var gp = new Geoprocessor(gpServiceUrl);

          // Run the gp task when the app loads to display default incidents 
          map.on("load", initToolbar);
          var td;
          function initToolbar(evtObj) {
              tb = new Draw(evtObj.map);
              tb.on("draw-end", doBuffer);
          }
          // 绑定工具单击事件
          query(".tool").on("click", function (evt) {
              if (tb) {
                  tb.activate(evt.target.id);
              }
          });

          function doBuffer(evtObj) {
              tb.deactivate();
              var geometry = evtObj.geometry, symbol;
              switch (geometry.type) {
                  case "point":
                      symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 10, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 0, 0]), 1), new Color([0, 255, 0, 0.25]));
                      break;
                  case "polyline":
                      symbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASH, new Color([255, 0, 0]), 1);
                      break;
                  case "polygon":
                      symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NONE, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]));
                      break;
              }

              var graphic = new Graphic(geometry, symbol);
              map.graphics.add(graphic);
              tojob(graphic);

          }
          function tojob(graphic) {
              // 第一步构造GP

              // 第二步，构造参数
              // 我们通过上面，了解到GPFeatureRecordSetLayer对应FeatureSet
              var features = [];
              features.push(graphic);
              var featureset = new esri.tasks.FeatureSet();
              featureset.features = features;
              // 构造缓冲长度，这里的单位是可以更改的，我使用的是度，简单一些
              var Dis = new esri.tasks.LinearUnit();
              Dis.distance = 0.1;
              Dis.units = esri.Units.DECIMAL_DEGREES;
              var params = {
              	  // 传入的几何对象
                  ContaminatedAreas: featureset,
                  // 分析范围对象
                  Distance: Dis
              };
              // 这里函数是异步的，使用函数是submitJob,同步的使用的是execute。
              // 成功之后，调用jobResult,建议看一下这个参数。
              gp.submitJob(params, gpJobComplete, gpJobStatus, gpJobFailed);

              // gp.submitJob(params, completeCallback, statusCallback);
          }

          function gpJobComplete(jobInfo) {
              // var jobId = jobInfo.jobId;
              // alert(jobId);
              var jobId = jobInfo.jobId;
              var status = jobInfo.jobStatus;
              if (status === esri.tasks.JobInfo.STATUS_SUCCEEDED) {
                  // 成功之后，将其中的结果取出来，当然这也是参数名字。
                  // 在模型中，想要取出中间结果，需要设置为模型参数
                  // 获取结果
                  // gp.getResultData(jobId, "polygon_Buffer", addResults,);
                  gp.getResultData(jobId, "textBuffer4", addResults, gpJobFailed);
              }
          }
          // 将受污染的城市，添加到地图上
          function addResults(results) {
              console.log(results);
              var features = results.value.features;
              for (var f = 0, fl = features.length; f < fl; f++) {
                  var feature = features[f];
                  // var polySymbolRed = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NONE, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([204, 102, 51]), 1), new dojo.Color([158, 184, 71, 1]));
                  var symbol = new SimpleFillSymbol(
                    SimpleFillSymbol.STYLE_SOLID,
                    new SimpleLineSymbol(
                      SimpleLineSymbol.STYLE_SOLID,
                      new Color([255, 0, 0, 0.65]), 2
                    ),
                    new Color([255, 0, 0, 0.35])
                  );

                  feature.setSymbol(symbol);
                  map.graphics.add(feature);
              }
          }
          // 返回状态
          function gpJobStatus(jobinfo) {
              // domUtils.show(dom.byId('status'));
              // var jobstatus = '';
              // switch (jobinfo.jobStatus) {
              //     case 'esriJobSubmitted':
              //         jobstatus = 'Submitted...';
              //         break;
              //     case 'esriJobExecuting':
              //         jobstatus = 'Executing...';
              //         break;
              //     case 'esriJobSucceeded':
              //         domUtils.hide(dom.byId('status'));
              //         break;
              // }
              // dom.byId('status').innerHTML = jobstatus;

          }
          function gpJobFailed(error) {
              alert(error);
          }
      });
    </script>
  </head>

<body class="claro">
<div data-dojo-type="dijit/layout/BorderContainer" 
     data-dojo-props="gutters:'true', design:'sidebar'" 
     style="width:100%;height:100%;">

  <div id="map" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'center'">
  </div>

  <div id="leftPane" 
       data-dojo-type="dijit/layout/ContentPane" 
       data-dojo-props="region:'left'">
    <div class="details">Pick a tool and draw on the map. The drawn graphic will be buffered based on the specified parameters.</div>
    <button type="button" class="tool" id="line">Line</button>
    <button type="button" class="tool" id="polyline">Polyline</button>
    <button type="button" class="tool" id="freehandpolyline">Freehand Polyline</button>
    <br/>
    <button type="button" class="tool" id="polygon">Polygon</button>
    <button type="button" class="tool" id="freehandpolygon">Freehand Polygon</button>
    <br/><hr />
    <div><b>Buffer Parameters</b></div>
    Distance: <input type="text" id="distance" size="5" value="25" />
    <select id="unit" style="width:100px;">
      <option value="UNIT_STATUTE_MILE">Miles</option>
      <option value="UNIT_FOOT">Feet</option>
      <option value="UNIT_KILOMETER">Kilometers</option>
      <option value="UNIT_METER">Meters</option>
      <option value="UNIT_NAUTICAL_MILE">Nautical Miles</option>
      <option value="UNIT_US_NAUTICAL_MILE">US Nautical Miles</option>
      <option value="UNIT_DEGREE">Degrees</option>
    </select><br />
    <button type="button" id="clearGraphics"  type="button">Clear Graphics</button>
  </div>
</div>
</body>
</html>
```

## Geoprocessing 类

### 构造函数

```js
new Geoprocessing(url)
```

- url：GP 服务路径

### 属性

- outSpatialReference：几何图形的空间参考输出
- processSpatialReference：空间参考模型将用来执行几何操作
- updateDelay：每个作业状态之间的时间间隔，以毫秒为单位请求发送
- url：服务路径

### 主要方法

- execute(inputParameters, callback?, errback?)：发送一个请求到服务器执行一个同步的任务
- submitJob(inputParameters, callback?, statusCallback?, errback?)：发送一个请求到服务器执行一个异步的任务
  inputParameters
- < GPFeatureRecordSetLayer > Input_Points：几何图形
- < GPDouble > Distance：分析范围
- getResultData(jobId, parameterName, callback?, errback?)：获取返回数据
- setUpdateDelay(delay)：设置每个作业状态之间的时间间隔，以毫秒为单位的请求发送到一个异步的的任务

### 主要事件

- error：产生错误事件
- execute-complete：执行同步完成事件
- get-result-data-complete：返回数据完成后事件
- status-update：状态更新事件

# 4、SOE模型

## 主要接口

### IServerObjectExtension

服务对象扩展接口，提供了对成员的访问控制和服务器对象的扩展。

- IServerObjectExtension 主要有两个方法：
- Init：该函数有一个 IServerObjectHelper 类型的参数。该函数在服务启动时被调用，并将IServerObjectHelper对象传入，此接口是对Server对象弱引用，可以通过其ServerObject 属性得到Server对象。
- Shutdown：该方法用在服务器关闭时调用，经常我们在该方法中释放SOE中使用的资源。

IServerObjectExtension 包含Init和ShutDown两个函数用来启动和停止SOE

### IRESTQuestHandler

获取请求模式接口，用于获取 REST 请求模式。

- IRESTQuestHandler 接口主要有两个方法：

- GetSchema()：以JSON格式返回SOE的资源列表

- HandleRESTREquest()：该方法主要有两个作用：回调资源和操作的方法、获取资源在实例级别的描述。该方法在识别这两个作用的时候是通过

  operationName参数，如果该参数是空字符产那就是第二个作用，否则是第一个作用。使用REST SOE必要的接口，用来获取请求并返回处理结果。他的方法

  主要用来创建Schema（模式）和处理Requests（请求）。

- HandleRESTREquest() 参数：

  该方法的参数如下：
  （1）String capabilities：一组被资源授权的操作，可以为空字符串
  （2）String resourceName：资源名称. 空字符串表示根级别，子资源会通过‘/’ 表示
  （3）String operationName：操作名称
  （4）String operationInput：操作的参数，JSON格式
  （5）String outputFormat：客户端请求的输出格式，如JSON，AMF
  （6）String[] responseProperties：通过操作返回的一组键值对，逗号分开

### IObjectConstruct

对象构造接口，提供方法来创建一个对象。
IObjectConstruct 方法只有一个 Construct 方法，只在SOE启动时运行一次，用来放置一些不需要在每次请求都运行的逻辑。

### SoeRestImpl 类

该类用来验证 SOE 的 Schema。

- 验证 HandlerRESTRequest 请求的 resourceName 和 OperationName
- 验证 SOE 的 Capabilities（性能）
- 记录服务请求和返回
- 处理错误

SoeRestImpl 类实现了 IRESTRequestHandler 接口。通常情况下 SOE 工程中都会有一个该类的实例和一个 IRESTRequestHandler 接口的引用。

## SOE 的生命周期

- MapServer初始化
- SOE初始化
- MapServer启动
- SOE构造
- SOE活动——REST/SOAP处理请求——SOE停止活动
- MapServer停止
- SOE关闭

## ArcGIS API for JavaScript 调用SOE

```js
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title></title>

    <link rel="stylesheet" href="https://js.arcgis.com/3.15/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.15/esri/css/esri.css">
    <script src="https://js.arcgis.com/3.15/"></script>
   	<style>  
        html, body, #mapDiv {  
            padding: 0;  
            margin: 0;  
            height: 100%;  
        }   
        #messages {  
            background-color: #fff;  
            box-shadow: 0 0 5px #888;  
            font-size: 1.1em;  
            max-width: 15em;  
            padding: 0.5em;  
            position: absolute;  
            right: 20px;  
            top: 300px;  
            z-index: 40;  
        }  
    </style>    
    <script> 
        var map;
        require([
          	"esri/map", 
          	"esri/layers/FeatureLayer",
          	"esri/layers/ArcGISDynamicMapServiceLayer",
         	"esri/request",
          	"esri/graphic", 
          	"esri/symbols/SimpleMarkerSymbol",
           	"esri/geometry/Point",
            "esri/SpatialReference",
          	"esri/config", 
          	"esri/Color", 
          	"dojo/_base/array", 
          	"dojo/on", 
          	"dojo/dom",
          	"dojo/json", 
          	"dojo/domReady!"
        ], function (
          	Map, 
          	FeatureLayer, 
          	ArcGISDynamicMapServiceLayer,
         	esriRequest,
          	Graphic, 
          	SimpleMarkerSymbol,
        	Point, 
        	SpatialReference,
          	esriConfig, 
          	Color, 
          	arrayUtils, 
          	on, 
          	dom, 
          	JSON
        ) {
            esriConfig.defaults.io.proxyUrl = "/proxy";

            map = new Map("mapDiv", {});
            var div1 = document.getElementById("div1")
            div1.innerHTML = "afdfd";
            var mapUrl = "http://localhost:6080/arcgis/rest/services/sd/MapServer";
            // 第一个重点就是我们的，SOE服务路径
            var soeUrl = "http://localhost:6080/arcgis/rest/services/sd/MapServer/exts/RestSOE1/sampleOperation";
            // Takes a URL to a non cached map service.  
            var myTiledMapServiceLayer = new esri.layers.ArcGISTiledMapServiceLayer(mapUrl);

            map.addLayer(myTiledMapServiceLayer);

            on(dom.byId("execute"), "click", function () {
                var WhereClause = dom.byId("WhereClause").value;
                var BufferRadius = dom.byId("BufferRadius").value;
                var content = {
                    'parm1': WhereClause,
                    'parm2': BufferRadius,
                    'f': "json"
                };

                // 第二个重点，向SOE传送参数，并回调
                var Request = esriRequest({
                    url: soeUrl,
                    content: content,
                    handleAs: "json",
                    callbackParamName: "callback"
                });
                 // 第三重点，获取SOE组件返回的数据
                Request.then(
                     function (responses) {
                         div1.innerHTML = responses.parm1 + "/" + responses.parm2                   
                     });
            });
        });
    </script>    
</head>  
  
<body>  
    参数1
    <input type="text" id="WhereClause" value="dd">  
    参数1 
    <input type="text" id="BufferRadius" value="dd">  
    <input id="execute" type="button" value="执行查询">  
    <div id="div1"></div>
    <div id="mapDiv"></div>  
</body>  
</html>  
```

