- [基于Nginx进行地图瓦片缓存的方案描述](https://www.cnblogs.com/naaoveGIS/p/9410551.html)

# 1. 背景

​     在产品的迭代中，我们完成了移动端瓦片缓存方案和服务端瓦片缓存方案。但是当我们遇到旧产品不易升级，或正式运行项目无法立刻进行产品更新时，我们可以采用基于Nginx的缓存设置来实现第三方瓦片服务的瓦片缓存。最近在某24小时运行项目中，团队成员hwg针对性的做了Nginx配置的设置和实施，我这里做一个总结。

# 2.Nginx的缓存策略

​    这里给出网友已经做好的一张示意图：

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802220930356-280268480.png)

​    其核心就是HIT检查，通过定义好的Key去缓存里获取，当没有获取到时则为MISS状态，然后进行服务转发，将获取的结果存入缓存。

# 3.实际项目详细配置

## 3.1定义缓存配置

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802220942696-634639854.png)

​    相关配置的详细说明：

　　proxy_cache_path:缓存存放路径。如果路径带上/，则表示绝对路径。如果不带/，则表示相对路径。这里写的my_cache，则是相对路径。

　　levels : 设置缓存文件目录层次；如果所有的缓存放入一个文件夹，则影响效率。这里设置的是levels=1:2 ，表示两级目录；

  key_zone : 在共享内存中设置一块存储区域来存放缓存的key和metadata（类似使用次数），这样nginx可以快速判断一个request是否命中或者未命中缓存，1m可以存储8000个key，10m可以存储80000个key；

　　max_size : 最大cache空间，如果不指定，会使用掉所有disk space，当达到配额后，会删除最少使用的cache文件；

　　inactive :  未被访问文件在缓存中保留时间，本配置中如果60分钟未被访问则不论状态是否为expired，缓存控制程序会删掉文件，默认为10分钟；“需要注意的是，inactive和expired配置项的含义是不同的，expired只是缓存过期，但不会被删除，inactive是删除指定时间内未被访问的缓存文件”；

　　use_temp_path : 如果为off，则nginx会将缓存文件直接写入指定的cache文件中，而不是使用temp_path存储，official建议为off，避免文件在不同文件系统中不必要的拷贝；

## 3.2 缓存使用

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221022633-1729056286.png)

​    proxy_cache :启用proxy cache，指定声明好的缓存区域key_zone;
​     proxy_cache_valid 200 206 304 301 302 10d; 含义为对httpcode为200\206等的缓存结果缓存10天；

　　 proxy_cache_key $uri ： 定义缓存唯一key,通过唯一key来进行hash存取;

​    proxy_no_cache和proxy_cache_bypass：当为0时表示缓存，不为0时表示不缓存。这里与匹配语句配合，当传入参数中包含指定规则时，才进行缓存。

## 3.3其他扩展配置

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221106680-2052566289.png)

​    对访问请求记录的日志路径，以及记录日志格式的定义。

# 4.结果测试

​    第一次访问时，未命中：

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221117239-2097001083.png)

   但是此时产生了缓存文件（二级目录）：

　![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221244303-625438330.png)

　　第二次访问时，命中：

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221129110-514970400.png)

​    查看日志，确定性能提升：

 ![img](https://images2018.cnblogs.com/blog/656746/201808/656746-20180802221259477-2027678647.png)